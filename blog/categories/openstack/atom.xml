<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: openstack | Pedro Jiménez's Blog]]></title>
  <link href="http://pedrojimenez.github.com/blog/categories/openstack/atom.xml" rel="self"/>
  <link href="http://pedrojimenez.github.com/"/>
  <updated>2013-01-28T16:54:48+01:00</updated>
  <id>http://pedrojimenez.github.com/</id>
  <author>
    <name><![CDATA[Pedro Jiménez Solís]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Openstack Installation - librarian and spiceweasel  Part I - Hosted Chef]]></title>
    <link href="http://pedrojimenez.github.com/blog/2013/01/28/openstack-installation-librarian-and-spiceweasel-part-i-hosted-chef/"/>
    <updated>2013-01-28T12:58:00+01:00</updated>
    <id>http://pedrojimenez.github.com/blog/2013/01/28/openstack-installation-librarian-and-spiceweasel-part-i-hosted-chef</id>
    <content type="html"><![CDATA[<center>
<img align=center
src="http://docs.opscode.com/_static/opscode_chef_html_logo.jpg">
</center>




<h2> **¿ Quiénes son ?**

Hemos de detenernos un instante para hacer meción especial a las 2 maravillosas
gemas que nos harán la vida muy sencilla con OpenStack. Hablamos de "librarian"
y de "spiceweasel". Para que la presentación sea bastante más oficial debemos
considerar que librarian será nuestro "cazador de cookbooks" y que spiceweasel
será el que los aplique contra el Servidor de Chef que elijamos, bien sea
público o privado. Además SpiceWeasel se encargará de aplicar roles/cookbooks a
los nodos directamente. Con esta pequeña "joya" se pueden hacer despliegues
verdaderamente veloces.

Librarian: 

Librarian-Chef is a bundler for infrastructure repositories using Chef. You can
use Librarian-Chef to resolve your infrastructure's cookbook dependencies,
fetch them, and install them into your infrastructure repository.

Enlace: <https://github.com/applicationsonline/librarian>


SpiceWeasel: 

Provides a CLI tool for generating knife commands to build Chef-managed
infrastructure from a simple JSON or YAML file.

Enlace: <http://wiki.opscode.com/display/chef/Spiceweasel>

<!-- more -->

<h2.> **stalación**

Así pues para poder automatizar tareas de instalación los utilizaremos a ambos.
Por un parte 




<pre><code class='bash'>
pjimenez@pedro-pruebas:~/openstack-chef-repo$ spiceweasel infrastructure.yml | sh

Uploading ntp          [1.2.0]
Uploaded 1 cookbook.
Uploading openssh        [1.1.0]
Uploaded 1 cookbook.
Uploading apt            [1.5.0]
Uploaded 1 cookbook.
Uploading yum            [1.0.0]
Uploaded 1 cookbook.
Uploading build-essential [1.1.2]
Uploaded 1 cookbook.
Uploading erlang         [1.1.0]
Uploaded 1 cookbook.
Uploading rabbitmq       [1.6.4]
Uploaded 1 cookbook.
Uploading openssl        [1.0.0]
Uploaded 1 cookbook.
Uploading mysql          [1.3.0]
Uploaded 1 cookbook.
Uploading postgresql     [1.0.0]
Uploaded 1 cookbook.
Uploading aws            [0.100.2]
Uploaded 1 cookbook.
Uploading xfs            [1.0.0]
Uploaded 1 cookbook.
Uploading database       [1.3.6]
Uploaded 1 cookbook.
Uploading apache2        [1.2.0]
Uploaded 1 cookbook.
Uploading selinux        [0.5.2]
Uploaded 1 cookbook.
Uploading sysctl         [0.1.2]
Uploaded 1 cookbook.
Uploading osops-utils    [1.0.6]
Uploaded 1 cookbook.
Uploading mysql-openstack [1.0.4]
Uploaded 1 cookbook.
Uploading rabbitmq-openstack [1.0.4]
Uploaded 1 cookbook.
Uploading keystone       [5.0.0]
Uploaded 1 cookbook.
Uploading glance         [5.0.0]
Uploaded 1 cookbook.
Uploading nova           [5.0.0]
Uploaded 1 cookbook.
Uploading horizon        [5.0.0]
Uploaded 1 cookbook.
Updated Environment production
Updated Role base!
Updated Role mysql-master!
Updated Role rabbitmq-server!
Updated Role keystone!
Updated Role glance-api!
Updated Role glance-registry!
Updated Role glance!
Updated Role nova-setup!
Updated Role nova-scheduler!
Updated Role nova-api-ec2!
Updated Role nova-api-os-compute!
Updated Role nova-volume!
Updated Role nova-vncproxy!
Updated Role horizon-server!
Updated Role single-controller!
Updated Role single-compute!
Updated Role allinone!
</code></pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ubuntu python-keystoneclient Dependency Error]]></title>
    <link href="http://pedrojimenez.github.com/blog/2012/12/12/ubuntu-python-keystoneclient-dependency-error/"/>
    <updated>2012-12-12T12:59:00+01:00</updated>
    <id>http://pedrojimenez.github.com/blog/2012/12/12/ubuntu-python-keystoneclient-dependency-error</id>
    <content type="html"><![CDATA[<p>Después de tener la infraestructura completa y funcional, nos encontramos ayer con un extraño error que no nos permitía el uso de Glance para poder hacer un "upload" de las imágenes. Nos encontramos con un error de dependencias en uno de los paquetes necesarios en la invocación de Glance.</p>

<p>Buscando algo más de información vemos que con la paquetería actual se llega a un error de versionado en el paquete <strong>python-keystoneclient</strong> y no permite que glance se ejecute.</p>

<pre>
root@controller:~# glance index
Traceback (most recent call last):
File "/usr/bin/glance", line 5, in <module>
from pkg_resources import load_entry_point
File "/usr/lib/python2.7/dist-packages/pkg_resources.py", line 2711, in <module>
parse_requirements(__requires__), Environment()
 File "/usr/lib/python2.7/dist-packages/pkg_resources.py", line 584, in resolve
raise DistributionNotFound(req)
pkg_resources.DistributionNotFound: python-keystoneclient>=0.1.2,<0.2
          
root@controller:~# glance image-list
Traceback (most recent call last):
File "/usr/bin/glance", line 5, in <module>
from pkg_resources import load_entry_point
File "/usr/lib/python2.7/dist-packages/pkg_resources.py", line 2711, in <module>
parse_requirements(__requires__), Environment()
File "/usr/lib/python2.7/dist-packages/pkg_resources.py", line 584, in resolve
raise DistributionNotFound(req)
pkg_resources.DistributionNotFound: python-keystoneclient>=0.1.2,<0.2
</pre>




<!-- more -->


<blockquote><p>AYUDA: Contactamos con nuestro Mcgyver personal, Gracias @achilued por la ayuda para ver la luz :)</p></blockquote>

<br />


<p>Lo primero vamos a comprobar con qué versión de paquetería contamos, tanto de los paquetes principales como de los auxiliares.</p>

<pre>
root@controller:~# dpkg -l | egrep 'nova|glance|python-keystone'
ii  glance                           2012.2.2+git201211300731~precise-0ubuntu1            OpenStack Image Registry and Delivery Service - Daemons
ii  glance-api                       2012.2.2+git201211300731~precise-0ubuntu1            OpenStack Image Registry and Delivery Service - API
ii  glance-common                    2012.2.2+git201211300731~precise-0ubuntu1            OpenStack Image Registry and Delivery Service - Common
ii  glance-registry                  2012.2.2+git201211300731~precise-0ubuntu1            OpenStack Image Registry and Delivery Service - Registry
ii  nova-api-ec2                     2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute - EC2 API frontend
rc  nova-api-metadata                2012.2+git201210091907~precise-0ubuntu1              OpenStack Compute - metadata API frontend
ii  nova-api-os-compute              2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute - OpenStack Compute API frontend
rc  nova-api-os-volume               2012.2+git201210091907~precise-0ubuntu1              OpenStack Compute - OpenStack Volume API frontend
ii  nova-cert                        2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute - certificate management
ii  nova-common                      2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute - common files
ii  nova-consoleauth                 2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute - Console Authenticator
ii  nova-novncproxy                  2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute - NoVNC proxy
ii  nova-scheduler                   2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute - virtual machine scheduler
rc  nova-volume                      2012.2+git201210091907~precise-0ubuntu1              OpenStack Compute - storage
ii  python-glance                    2012.2.2+git201211300731~precise-0ubuntu1            OpenStack Image Registry and Delivery Service - Python library
ii  python-glanceclient              1:0.5.1.8.cdc06d9+git201210051430~precise-0ubuntu1   Client library for Openstack glance server.
ii  python-keystone                  2012.2.2+git201212061213~precise-0ubuntu1            OpenStack identity service - Python library
ii  python-keystoneclient            1:0.2.0.1.ge4ed1f3+git201211221523~precise-0ubuntu1  Client library for OpenStack Identity API
ii  python-nova                      2012.2.2+git201212111304~precise-0ubuntu1            OpenStack Compute Python libraries
ii  python-novaclient                1:2.9.0.49.gdc6285c+git201211221531~precise-0ubuntu1 client library for OpenStack Compute API
</pre>


<p>Vemos un apunte clarísimo y es que la versión del paquete <em>python-keystoneclient</em> es efectivamente superior a 0.2 , más concretamente se encuentra instalada la vesión <strong>0.2.0.1</strong> que al no cumplir con las exigencias del paquete Glance nos expulsa de su ejecución. Vamos a tirar un poco del hilo para ver si podemos arreglar este entuerto.</p>

<p>PASO 1: Se buscan las dependencias que tiene Glance y encontramos el directorio donde se aloja el cliente.
```
$ root@controller:~# cat /usr/bin/glance</p>

<h1>!/usr/bin/python</h1>

<h1>EASY-INSTALL-ENTRY-SCRIPT: 'python-glanceclient==0.5.1.8.cdc06d9','console_scripts','glance'</h1>

<p><strong>requires</strong> = 'python-glanceclient==0.5.1.8.cdc06d9'
import sys
from pkg_resources import load_entry_point</p>

<p>if <strong>name</strong> == '<strong>main</strong>':</p>

<pre><code>sys.exit(
        load_entry_point('python-glanceclient==0.5.1.8.cdc06d9', 'console_scripts', 'glance')()
        )
</code></pre>

<p>```</p>

<p>PASO2: Dentro de dicho directorio editamos el fichero con las dependecias y se elimina la superior del paquete <strong>python-keystoneclient</strong>.</p>

<pre>
RUTA: /usr/lib/python2.7/dist-packages/python_glanceclient-0.5.1.8.cdc06d9.egg-info/requires.txt 

CAMBIAMOS:
prettytable>=0.6,<0.7
python-keystoneclient>=0.1.2,<0.2
warlock<2

POR:
prettytable>=0.6,<0.7
python-keystoneclient>=0.1.2
warlock<2
</pre>


<p>PASO3: Comprobamos que Glance vuelve a operar con normalidad.
```
$ glance index
ID                                   Name                           Disk Format          Container Format     Size</p>

<hr />

<p>de4bdf11-5b5e-4ca7-a29c-2c38ebe07697 cirros-image                   qcow2                bare                        9761280
```</p>

<p>Más información:
<a href="https://bugs.launchpad.net/openstack-manuals/+bug/1064449">https://bugs.launchpad.net/openstack-manuals/+bug/1064449</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Database Access Error in Folsom]]></title>
    <link href="http://pedrojimenez.github.com/blog/2012/11/16/database-access-error-in-folsom/"/>
    <updated>2012-11-16T11:32:00+01:00</updated>
    <id>http://pedrojimenez.github.com/blog/2012/11/16/database-access-error-in-folsom</id>
    <content type="html"><![CDATA[<p>Después de darle muchas vueltas al asunto, el comodín que se utilizaba en Mysql 5.1 (versión usada Diablo and Essex) el conocido "%" ha comenzado a fallar. Nos encontramos con errores de acceso a las Bases de Datos que eran nuevos para mi hasta el momento. Revisando las bitácoras de instalaciones previas hemos visto que los permisos de acceso a las diferentes DataBases de Mysql han cambiado y se utiliza como única línea de permisos la siguiente:</p>

<pre>
mysql_database_user[keystone]: granting access with statement [GRANT all ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'onetimepassword']
</pre>


<p>Pero solamente con esta sentencia constatamos que el acceso desde otros nodos (multihost) nos daba error. Para solucionar estos problemas se ha probado a añadir sentencias extras de "GRANT" hasta que permitió dichas conexiones. Haciendo un resumen de todas ellas se ha modificado el cookbook de osops-utils para que añada una nueva sentencia de GRANT contra la dirección en la que se bindea el servicio de Mysql. De esta manera se podrá configurar el servicio de Base de Datos en HA y tener los accesos contra la "bind_address".</p>

<pre>
Archivo "osops-utils/libraries/database.rb"

        mysql_database_user username do
          connection connection_info
          password pw
          database_name db_name
          host "#{mysql_info["bind_address"]}"
          privileges [:all]
          action :grant
        end
</pre>


<p>Se ha hecho un <em>Pull Request</em> a la gente de <em>Rcbops</em> con esta modificación.<a href="https://github.com/rcbops-cookbooks/osops-utils/pull/46#issuecomment-10194833">Enlace</a>.</p>

<p>Ahora mismo lo estoy usando en nuestro Chef Server en el despligue de Folsom y funciona "like a charm". Nos genera dos sentencias de permisos para cada servicio (keystone/glance/nova/horizon).</p>

<pre>
INFO: Processing mysql_database_user[keystone] action grant (keystone::server line 24)
INFO: mysql_database_user[keystone]: granting access with statement [GRANT all ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'onetimepassword']
INFO: Processing mysql_database_user[keystone] action grant (keystone::server line 32)
INFO: mysql_database_user[keystone]: granting access with statement [GRANT all ON keystone.* TO 'keystone'@'172.16.172.4' IDENTIFIED BY 'onetimepassword']
</pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Keystone user-role-list bug]]></title>
    <link href="http://pedrojimenez.github.com/blog/2012/11/15/keystone-user-role-list-bug/"/>
    <updated>2012-11-15T15:02:00+01:00</updated>
    <id>http://pedrojimenez.github.com/blog/2012/11/15/keystone-user-role-list-bug</id>
    <content type="html"><![CDATA[<p>Depurando el comportamiento de Keystone para solventar un error que me trae de cabeza en Glance, he visto que un nuevos comandos que se han añadido al servicio de Identidad en OpenStack ("keystone user-role-list"). Este comando nos permitirá extraer un listado de los usuarios/roles/tenants de un solo vistazo.</p>

<p>Problema: que ahora mismo no funciona como se espera. Tan solo muestra el listado de los roles que hay para el usurio que tenemos en las variables de entorno (cargadas en el fichero novarc o como queramos llamarlo). Necesitaba conocer dicho listado del usuario "glance" no del usuario "admin". En una primera pasada vemos que el listado solamente nos permite obtener los del mismo usuario "admin":</p>

<pre>
keystone role-list
+----------------------------------+----------------------+
|                id                |         name         |
+----------------------------------+----------------------+
| 06bc817f9b8647d3bb795c6a1107cff3 |    KeystoneAdmin     |
| 1e77a4036d42446aabcfc706759b732d | KeystoneServiceAdmin |
| 25fcba9f9b9a4982a77f70fd2c84fc31 |        admin         |
| 28941e6016ea488cad9e5e55fee7d8aa |        Member        |
+----------------------------------+----------------------+

keystone tenant-list
+----------------------------------+---------+---------+
|                id                |   name  | enabled |
+----------------------------------+---------+---------+
| 15eafea37ce24b42ab60b1fe0f882d98 | service |   true  |
| 18e181671f174cc1bce64e4370eea96a |  admin  |   true  |
+----------------------------------+---------+---------+

keystone user-list
+----------------------------------+------------+---------+-------+
|                id                |    name    | enabled | email |
+----------------------------------+------------+---------+-------+
| 4be33d2e90ad42ce867954b07aa7b908 |   admin    |   true  |       |
| 8c53cdc1f4354e77a8e2abd39728b20d |    nova    |   true  |       |
| bd9e78ff6ca84c7181f3f412a01597ed | monitoring |   true  |       |
| f6b72f21414246d0a924fc883e694f45 |   glance   |   true  |       |
+----------------------------------+------------+---------+-------+

keystone user-role-list
+----------------------------------+----------------------+----------------------------------+----------------------------------+
|                id                |         name         |             user_id              |            tenant_id             |
+----------------------------------+----------------------+----------------------------------+----------------------------------+
| 06bc817f9b8647d3bb795c6a1107cff3 |    KeystoneAdmin     | 4be33d2e90ad42ce867954b07aa7b908 | 18e181671f174cc1bce64e4370eea96a |
| 1e77a4036d42446aabcfc706759b732d | KeystoneServiceAdmin | 4be33d2e90ad42ce867954b07aa7b908 | 18e181671f174cc1bce64e4370eea96a |
| 25fcba9f9b9a4982a77f70fd2c84fc31 |        admin         | 4be33d2e90ad42ce867954b07aa7b908 | 18e181671f174cc1bce64e4370eea96a |
+----------------------------------+----------------------+----------------------------------+----------------------------------+
</pre>




<!-- more -->


<p>Para este listado el usuario sigue siendo el mismo: 4be33d2e90ad42ce867954b07aa7b908 y por un ratillo incluso pensé que el resto de usuarios no se habrían creado, pero no era realmente así. Un pequeño vistazo a la DB me lo dejó bien claro. Buscando algo de información sobre el comando (maravilla de doc oficial) y al hacer el "help" del comando me encontré que se puede especificar el usuario y el tenant.</p>

<p>Pues manos a la obra, ahora es viable sacar el resto de la información para completar lo que en un futuro será la salida estandar del comando. Tampoco estaría mal poder especificar uno de los dos parámetros, o bien el usuario o bien el tenant, pero os adelanto que no es así. Hay que especificar ambos.</p>

<pre>
keystone help user-role-list
usage: keystone user-role-list [--user-id <user-id>] [--tenant-id <tenant-id>]

List roles granted to a user

Optional arguments:
  --user-id <user-id>   List roles granted to a user
  --tenant-id <tenant-id>
                        List roles granted on a tenant

- - - - - - - - - - -
user Glance:
root@controller:/etc/glance# keystone user-role-list --user-id f6b72f21414246d0a924fc883e694f45 --tenant-id 15eafea37ce24b42ab60b1fe0f882d98
+----------------------------------+-------+----------------------------------+----------------------------------+
|                id                |  name |             user_id              |            tenant_id             |
+----------------------------------+-------+----------------------------------+----------------------------------+
| 25fcba9f9b9a4982a77f70fd2c84fc31 | admin | f6b72f21414246d0a924fc883e694f45 | 15eafea37ce24b42ab60b1fe0f882d98 |
+----------------------------------+-------+----------------------------------+----------------------------------+

user Nova:
root@controller:/etc/glance# keystone user-role-list  --user-id 8c53cdc1f4354e77a8e2abd39728b20d --tenant-id 15eafea37ce24b42ab60b1fe0f882d98
+----------------------------------+-------+----------------------------------+----------------------------------+
|                id                |  name |             user_id              |            tenant_id             |
+----------------------------------+-------+----------------------------------+----------------------------------+
| 25fcba9f9b9a4982a77f70fd2c84fc31 | admin | 8c53cdc1f4354e77a8e2abd39728b20d | 15eafea37ce24b42ab60b1fe0f882d98 |
+----------------------------------+-------+----------------------------------+----------------------------------+


Rol Admin: | 25fcba9f9b9a4982a77f70fd2c84fc31 |
</pre>


<p>Espero que os sirva para un apuro o para el debug de vuestra plataforma.</p>

<p>Enlaces:
<a href="http://docs.openstack.org/trunk/openstack-compute/admin/content/adding-users-tenants-and-roles-with-python-keystoneclient.html">http://docs.openstack.org/trunk/openstack-compute/admin/content/adding-users-tenants-and-roles-with-python-keystoneclient.html</a><br />
<a href="https://bugs.launchpad.net/python-keystoneclient/+bug/1058750">https://bugs.launchpad.net/python-keystoneclient/+bug/1058750</a><br />
<a href="http://www.gossamer-threads.com/lists/openstack/dev/19510">http://www.gossamer-threads.com/lists/openstack/dev/19510</a><br /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ubuntu Keyring password and Folsom]]></title>
    <link href="http://pedrojimenez.github.com/blog/2012/11/15/ubuntu-keyring-password-and-folsom/"/>
    <updated>2012-11-15T11:16:00+01:00</updated>
    <id>http://pedrojimenez.github.com/blog/2012/11/15/ubuntu-keyring-password-and-folsom</id>
    <content type="html"><![CDATA[<p>Pues después de varios intentos con la infraestructura de Folsom, al final en todas ellas he conseguido llegar a este punto de error. Después de leer por ahí, la solución es bastante sencilla y se aplica de manea instantánea sobre línea de comandos.</p>

<p>Este error nos salta cuando tratamos de invocar los comandos de "nova" después de haber generado y cargado las variables de entorno en el fichero novarc (o el nombre que elijamos).</p>

<pre>
root@controller:~# nova list
Please set a password for your new keyring
</pre>


<p>Aunque metamos una contraseña, nos seguirá molestando con este error de manera continuada. Para evitarlo basta con añadir la línea de abajo al bashrc del usuario y volver a cargarlo.</p>

<pre>
Añadimos al /home/user/.bashrc y recargamos
export OS_NO_CACHE=1
source /home/user/.bashrc 
</pre>


<p>Comprobamos que se ejecutan los comandos de "nova":</p>

<pre>
root@controller:/etc/nova# nova volume-list
+--------------------------------------+-----------+-----------------+------+-------------+-------------+
| ID                                   | Status    | Display Name    | Size | Volume Type | Attached to |
+--------------------------------------+-----------+-----------------+------+-------------+-------------+
| 850e5d38-dc87-4267-b3c9-9d02205f11ab | available | MiPrimerVolumen | 3    | None        |             |
+--------------------------------------+-----------+-----------------+------+-------------+-------------+
</pre>


<p>La segunda opción es ejecutar los comandos de "nova" con la opción <u>--no_cache</u>, aunque sobre el mismo entorno no he sido capaz de que funcione con dichas indicaciones.</p>

<pre>
root@controller:~# nova --no_cache volume-list
</pre>


<p>Enlaces:</p>

<p><a href="https://bugs.launchpad.net/python-novaclient/+bug/1020238">https://bugs.launchpad.net/python-novaclient/+bug/1020238</a></p>

<p><a href="https://lists.launchpad.net/openstack/msg16095.html">https://lists.launchpad.net/openstack/msg16095.html</a> (solución de Vish)</p>
]]></content>
  </entry>
  
</feed>
